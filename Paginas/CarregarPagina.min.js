const APP_VERSION="versao.2.0.45";function getSavedTheme(){try{if(window.LGPDCOOKIES&&"function"==typeof LGPDCOOKIES.getValueCookie)return LGPDCOOKIES.getValueCookie("modoEscuro")}catch{}try{return localStorage.getItem("modoEscuro")}catch{}return null}function applySavedTheme(e){const t=getSavedTheme(),o=(e=e||document).querySelector('meta[name="color-scheme"]');"1"===t?(e.documentElement.classList.add("dark-mode"),e.body&&e.body.classList.add("dark-mode"),o&&o.setAttribute("content","dark")):(e.documentElement.classList.remove("dark-mode"),e.body&&e.body.classList.remove("dark-mode"),o&&o.setAttribute("content","light"))}if(window.addEventListener("pageshow",()=>applySavedTheme(document)),window.scriptSources=window.scriptSources||[],applySavedTheme(document),void 0===window.csrfSetup){window.csrfSetup=!0,window.csrfToken=null;let e=fetch("/GetCSRF.php").then(e=>e.json()).then(e=>{window.csrfToken=e.token}).catch(()=>{});const t=window.fetch.bind(window);window.fetch=async function(o,n={}){if(n&&"POST"===(n.method||"GET").toUpperCase()){if(n.headers=n.headers||{},!window.csrfToken)try{await e}catch{}window.csrfToken&&(n.headers instanceof Headers?n.headers.append("X-CSRF-Token",window.csrfToken):n.headers["X-CSRF-Token"]=window.csrfToken)}try{return await t(o,n)}catch(e){throw navigator.onLine||redirecionarSeOffline(),e}}}async function clearCachesAndReload(){try{const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}finally{location.reload()}}localStorage.getItem("app_version")||localStorage.setItem("app_version",APP_VERSION);const storedVersion=localStorage.getItem("app_version");storedVersion&&storedVersion!==APP_VERSION&&(localStorage.setItem("app_version",APP_VERSION),clearCachesAndReload());const redir=new URLSearchParams(location.search).get("url");redir&&(location.href=redir);const OFFLINE_PAGE="/Paginas/PaginaErros/PaginaErros.html";function redirecionarSeOffline(){if(!navigator.onLine&&location.pathname!==OFFLINE_PAGE){try{sessionStorage.setItem("offline-redirect",location.href)}catch{}location.replace(`${OFFLINE_PAGE}?code=offline`)}}const MAINTENANCE_FILE="/ModoManutencao.json";async function verificarManutencao(){try{const e=await fetch(`${MAINTENANCE_FILE}?v=${APP_VERSION}`,{cache:"no-store"});if(e.ok){const t=await e.json();t&&t.maintenance&&location.pathname!==OFFLINE_PAGE&&location.replace(`${OFFLINE_PAGE}?code=manutencao`)}}catch{}}function mostrarAvisoAtualizacao(e){"function"==typeof e&&e()}async function carregarPagina(e,t=!0){try{const o=fetch(`/Layout/Estrutura/Layout.html?v=${APP_VERSION}`).then(e=>e.text()),n=fetch(`${e}?v=${APP_VERSION}`).then(e=>e.text());let r=Promise.resolve(""),a=Promise.resolve(null);t&&(r=fetch(`/Paginas/Universais/GerarProdutoeInformacoesProduto.html?v=${APP_VERSION}`).then(e=>e.text()),a=fetch(`/Paginas/AreaCliente/AcessoCadastro/Acesso/ValidarSessao.php?v=${APP_VERSION}`).then(e=>e.json()).catch(()=>null));let[c,i,s,d]=await Promise.all([o,n,r,a]),l="";if(t&&d){const e=d.grupo?.toUpperCase()||"";"OURO"===e||"DIAMANTE"===e?l=await fetch(`/Paginas/Universais/EstoqueExterno.html?v=${APP_VERSION}`).then(e=>e.text()):"ADMINISTRADOR"!==e&&"INTERNO"!==e||(l=await fetch(`/Paginas/Universais/EstoqueInterno.html?v=${APP_VERSION}`).then(e=>e.text()))}const u=window.scriptSources;u.length=0,c=c.replace(/<script\b([^>]*)\bsrc="([^"]+)"([^>]*)><\/script>/gi,(e,t,o,n)=>{const r=`${t} ${n}`.trim(),a={};return r.replace(/([\w-:]+)(?:=(["'])(.*?)\2)?/g,(e,t,o,n)=>{a[t]=void 0===n||n}),u.push({src:o,attrs:a}),""});const m=i+s+l,h=(new DOMParser).parseFromString(c,"text/html");applySavedTheme(h);const p=h.querySelector("footer");p?p.insertAdjacentHTML("beforebegin",m):h.body.insertAdjacentHTML("beforeend",m);for(const e of Array.from(h.documentElement.attributes))document.documentElement.setAttribute(e.name,e.value);const f=[],A=(e,t)=>{e.innerHTML="";for(const o of Array.from(t.childNodes))if("SCRIPT"===o.tagName){const t=document.createElement("script");for(const e of Array.from(o.attributes))t.setAttribute(e.name,e.value);t.textContent=o.textContent,t.src&&f.push(new Promise(e=>{t.onload=e,t.onerror=e})),e.appendChild(t)}else e.appendChild(o.cloneNode(!0))};A(document.head,h.head),A(document.body,h.body);const E=(new DOMParser).parseFromString(i,"text/html"),S=E.querySelector("title");S&&(document.title=S.textContent);for(const e of E.head.querySelectorAll("meta[name], meta[property]")){let t=e.hasAttribute("name")?`meta[name="${e.getAttribute("name")}"]`:`meta[property="${e.getAttribute("property")}"]`,o=document.head.querySelector(t);o||(o=document.createElement("meta"),e.hasAttribute("name")&&o.setAttribute("name",e.getAttribute("name")),e.hasAttribute("property")&&o.setAttribute("property",e.getAttribute("property")),document.head.appendChild(o));const n=e.getAttribute("content");null!==n&&o.setAttribute("content",n)}const w=E.head.querySelector('link[rel="canonical"]');if(w){let e=document.head.querySelector('link[rel="canonical"]');e||(e=document.createElement("link"),e.setAttribute("rel","canonical"),document.head.appendChild(e)),e.setAttribute("href",w.getAttribute("href"))}await Promise.all(f);const P=({src:e,attrs:t})=>new Promise(o=>{const n=document.createElement("script");if(n.src=e,t)for(const[e,o]of Object.entries(t))"src"!==e&&(!0===o?n.setAttribute(e,""):n.setAttribute(e,o));n.onload=o,n.onerror=o,document.head.appendChild(n)});for(const e of u)await P(e);document.dispatchEvent(new Event("DOMContentLoaded")),window.dispatchEvent(new Event("load"));const g=document.getElementById("titulo-estrutural");g&&g.remove()}catch(e){navigator.onLine?document.body.innerHTML=`<p style="color:red">⚠️ Erro ao Carregar a Página: ${e.message}</p>`:location.replace(`${OFFLINE_PAGE}?code=offline`)}}verificarManutencao(),window.addEventListener("offline",redirecionarSeOffline),redirecionarSeOffline(),!("serviceWorker"in navigator)||"https:"!==location.protocol&&"localhost"!==location.hostname||(navigator.serviceWorker.register(`/Service-Worker.min.js?versao=${APP_VERSION}`,{updateViaCache:"none"}).then(e=>{"periodicSync"in e&&e.periodicSync.register("update-content",{minInterval:864e5}).catch(()=>{}),"sync"in e&&e.sync.register("sync-requests").catch(()=>{})}).catch(e=>console.warn("Service worker registration failed:",e)),navigator.serviceWorker.addEventListener("message",e=>{const t=e.data;if(t&&("updated"===t||"updated"===t.type)){const e=t.version||APP_VERSION,o=localStorage.getItem("app_version");e!==o&&mostrarAvisoAtualizacao(()=>{localStorage.setItem("app_version",e),clearCachesAndReload()})}}));